name: Build PulseView + Sigrok Stack Debian Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g. 0.4.2)'
        required: false
        default: '0.4.2'

env:
  PKG_NAME: sigrok-pulseview
  PKG_VERSION: ${{ github.event.inputs.version || '0.4.2' }}
  PKG_RELEASE: 1

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            qemu: false
          - arch: arm64
            platform: linux/arm64
            qemu: true
          - arch: riscv64
            platform: linux/riscv64
            qemu: true

    name: Build ${{ matrix.arch }}
    timeout-minutes: 720

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        if: matrix.qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: echo "PKG_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Build .deb in container
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/src \
            -v ${{ github.workspace }}/output:/output \
            -e PKG_NAME="${{ env.PKG_NAME }}" \
            -e PKG_VERSION="${{ env.PKG_VERSION }}" \
            -e PKG_RELEASE="${{ env.PKG_RELEASE }}" \
            -e DEBIAN_FRONTEND=noninteractive \
            ubuntu:noble bash -c '
              set -ex

              ##############################################
              # 1. Install all build dependencies
              ##############################################
              apt-get update
              apt-get install -y --no-install-recommends \
                build-essential cmake pkg-config git ca-certificates \
                autoconf automake libtool \
                libglib2.0-dev libglibmm-2.4-dev \
                libzip-dev zlib1g-dev \
                libusb-1.0-0-dev libftdi1-dev \
                libieee1284-3-dev libhidapi-dev \
                libnettle-dev libavahi-client-dev \
                python3-dev python3-setuptools \
                libboost-dev libboost-test-dev libboost-filesystem-dev \
                libboost-serialization-dev libboost-system-dev libboost-thread-dev \
                qtbase5-dev libqt5svg5-dev qttools5-dev \
                libfftw3-dev sdcc doxygen swig \
                checkinstall

              PREFIX=/usr
              export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PREFIX}/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)/pkgconfig:${PKG_CONFIG_PATH}"
              export LD_LIBRARY_PATH="${PREFIX}/lib:${PREFIX}/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH):${LD_LIBRARY_PATH}"
              NPROC=$(nproc)

              ##############################################
              # 2. Build libserialport
              ##############################################
              cd /tmp
              git clone git://sigrok.org/libserialport
              cd libserialport
              ./autogen.sh
              ./configure --prefix=${PREFIX}
              make -j${NPROC}
              make install
              ldconfig

              ##############################################
              # 3. Build libsigrok
              ##############################################
              cd /tmp
              git clone git://sigrok.org/libsigrok
              cd libsigrok
              ./autogen.sh
              ./configure --prefix=${PREFIX} --disable-java
              make -j${NPROC}
              make install
              ldconfig

              # Install udev rules
              mkdir -p /usr/lib/udev/rules.d
              if [ -f contrib/60-libsigrok.rules ]; then
                cp contrib/60-libsigrok.rules /usr/lib/udev/rules.d/
              fi
              if [ -f contrib/61-libsigrok-plugdev.rules ]; then
                cp contrib/61-libsigrok-plugdev.rules /usr/lib/udev/rules.d/
              fi
              if [ -f contrib/61-libsigrok-uaccess.rules ]; then
                cp contrib/61-libsigrok-uaccess.rules /usr/lib/udev/rules.d/
              fi

              ##############################################
              # 4. Build libsigrokdecode
              ##############################################
              cd /tmp
              git clone git://sigrok.org/libsigrokdecode
              cd libsigrokdecode
              ./autogen.sh
              ./configure --prefix=${PREFIX}
              make -j${NPROC}
              # Skip tests on arm64/riscv64 (known flaky)
              ARCH=$(dpkg --print-architecture)
              if [ "$ARCH" = "amd64" ]; then
                make check || true
              fi
              make install
              ldconfig

              ##############################################
              # 5. Build sigrok-cli
              ##############################################
              cd /tmp
              git clone git://sigrok.org/sigrok-cli
              cd sigrok-cli
              ./autogen.sh
              ./configure --prefix=${PREFIX}
              make -j${NPROC}
              make install

              ##############################################
              # 6. Build sigrok-firmware-fx2lafw
              ##############################################
              cd /tmp
              git clone git://sigrok.org/sigrok-firmware-fx2lafw
              cd sigrok-firmware-fx2lafw
              ./autogen.sh
              ./configure --prefix=${PREFIX}
              make -j${NPROC}
              make install

              ##############################################
              # 7. Build PulseView
              ##############################################
              cd /tmp
              git clone git://sigrok.org/pulseview
              cd pulseview
              mkdir build && cd build
              cmake ../ \
                -DCMAKE_INSTALL_PREFIX=${PREFIX} \
                -DCMAKE_BUILD_TYPE=Release \
                -DDISABLE_WERROR=y \
                -DENABLE_DECODE=y \
                -DENABLE_TESTS=OFF
              make -j${NPROC}

              # Pre-create dirs checkinstall might miss
              mkdir -p ${PREFIX}/share/doc/${PKG_NAME}
              mkdir -p ${PREFIX}/share/applications
              mkdir -p ${PREFIX}/share/icons
              mkdir -p ${PREFIX}/share/metainfo
              mkdir -p ${PREFIX}/share/man/man1

              ##############################################
              # 8. Package everything with checkinstall
              #    We snapshot the full sigrok install
              ##############################################

              # Create a master install script that captures everything
              cat > /tmp/install-all.sh << "INSTALL_EOF"
              #!/bin/bash
              set -ex
              cd /tmp/libserialport && make install
              cd /tmp/libsigrok && make install
              cd /tmp/libsigrokdecode && make install
              cd /tmp/sigrok-cli && make install
              cd /tmp/sigrok-firmware-fx2lafw && make install
              cd /tmp/pulseview/build && make install

              # udev rules
              mkdir -p /usr/lib/udev/rules.d
              for f in /tmp/libsigrok/contrib/6*-libsigrok*.rules; do
                [ -f "$f" ] && cp "$f" /usr/lib/udev/rules.d/
              done
          INSTALL_EOF
              chmod +x /tmp/install-all.sh

              checkinstall \
                --type=debian \
                --pkgname="${PKG_NAME}" \
                --pkgversion="${PKG_VERSION}" \
                --pkgrelease="${PKG_RELEASE}" \
                --arch=$(dpkg --print-architecture) \
                --pkglicense="GPL-3.0" \
                --pkggroup="electronics" \
                --maintainer="seb@penthertz.com" \
                --provides="pulseview,sigrok-cli,libsigrok,libsigrokdecode,libserialport,sigrok-firmware-fx2lafw" \
                --requires="libglib2.0-0t64,libusb-1.0-0,libftdi1-2,libzip4t64,zlib1g,libqt5core5t64,libqt5gui5t64,libqt5widgets5t64,libqt5svg5,libboost-filesystem1.83.0,libboost-serialization1.83.0,libboost-system1.83.0,libboost-thread1.83.0,libfftw3-single3,libhidapi-hidraw0,python3,libnettle8t64,libglibmm-2.4-1t64,libieee1284-3" \
                --nodoc \
                --backup=no \
                --deldoc=yes \
                --deldesc=yes \
                --delspec=yes \
                --default \
                --install=no \
                /tmp/install-all.sh

              cp *.deb /output/
              echo "Built package:"
              ls -lh /output/*.deb
              dpkg-deb --info /output/*.deb
              echo "Package contents (first 50 lines):"
              dpkg-deb --contents /output/*.deb | head -50
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}_${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}_${{ matrix.arch }}
          path: output/*.deb
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: debs
          merge-multiple: true

      - name: List packages
        run: |
          echo "=== Built packages ==="
          ls -lh debs/
          for f in debs/*.deb; do
            echo "--- $(basename $f) ---"
            dpkg-deb --info "$f" | grep -E '(Package|Version|Architecture|Installed-Size|Depends|Provides)'
          done

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: debs/*.deb
          generate_release_notes: true
          body: |
            ## Sigrok PulseView ${{ env.PKG_VERSION }}

            Pre-built Debian packages for Ubuntu Noble (24.04).
            Includes the full sigrok stack: libserialport, libsigrok, libsigrokdecode, sigrok-cli, PulseView, and fx2lafw firmware.

            ### Install
            ```bash
            wget <url-to-deb>
            sudo dpkg -i sigrok-pulseview_*.deb
            sudo apt-get install -f -y
            sudo ldconfig
            sudo udevadm control --reload-rules && sudo udevadm trigger
            ```

            ### Included
            - **PulseView** - Qt-based logic analyzer GUI
            - **sigrok-cli** - Command-line interface
            - **libsigrok** - Hardware access library
            - **libsigrokdecode** - Protocol decoder library
            - **libserialport** - Serial port library
            - **fx2lafw** - Firmware for FX2-based logic analyzers

            ### Architectures
            - `amd64` - x86_64
            - `arm64` - AArch64
            - `riscv64` - RISC-V 64

      - name: Upload debs for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: all-debs-${{ env.PKG_VERSION }}
          path: debs/*.deb
          retention-days: 90